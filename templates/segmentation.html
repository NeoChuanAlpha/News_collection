{% extends "base.html" %}

{% block title %}分词结果 - 新闻分析系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h2 class="mb-0">分词结果</h2>
                <div>
                    <input type="text" id="search-input" class="form-control" placeholder="搜索新闻标题或分词...">
                </div>
            </div>
            <div class="card-body">
                <p>以下是新闻标题的分词处理结果，包括词性标注和词频统计。</p>
                
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>标题</th>
                                <th>分词结果</th>
                                <th>词性标注</th>
                                <th>词数</th>
                            </tr>
                        </thead>
                        <tbody id="segmentation-table">
                            <tr>
                                <td colspan="5" class="text-center">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <nav aria-label="分页导航">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- 分页将通过JavaScript动态生成 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">词性分布</h3>
            </div>
            <div class="card-body">
                <div id="pos-chart" style="width: 100%; height: 400px;"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h3 class="mb-0">词长分布</h3>
            </div>
            <div class="card-body">
                <div id="word-length-chart" style="width: 100%; height: 400px;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 全局变量
    let segmentationData = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    
    // 页面加载完成后执行
    $(document).ready(function() {
        // 获取分词数据
        loadSegmentationData();
        
        // 搜索功能
        $('#search-input').on('keyup', function() {
            currentPage = 1;
            renderTable();
        });
    });
    
    // 加载分词数据
    function loadSegmentationData() {
        $.ajax({
            url: '/api/segmentation',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    segmentationData = response.data;
                    renderTable();
                    renderPosChart();
                    renderWordLengthChart();
                } else {
                    alert('获取分词数据失败：' + response.message);
                }
            },
            error: function(xhr) {
                alert('获取分词数据出错：' + xhr.statusText);
            }
        });
    }
    
    // 渲染表格
    function renderTable() {
        const searchTerm = $('#search-input').val().toLowerCase();
        
        // 过滤数据
        const filteredData = segmentationData.filter(function(item) {
            return item.title.toLowerCase().includes(searchTerm) || 
                   item.segmented_words.toLowerCase().includes(searchTerm);
        });
        
        // 计算分页
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
        const pageData = filteredData.slice(startIndex, endIndex);
        
        // 渲染表格内容
        let tableHtml = '';
        
        if (pageData.length === 0) {
            tableHtml = '<tr><td colspan="5" class="text-center">没有找到匹配的数据</td></tr>';
        } else {
            pageData.forEach(function(item) {
                tableHtml += `
                    <tr>
                        <td>${item.news_id}</td>
                        <td>${item.title}</td>
                        <td>${formatSegmentedWords(item.segmented_words)}</td>
                        <td>${formatPosTagging(item.pos_tagging)}</td>
                        <td>${item.word_count}</td>
                    </tr>
                `;
            });
        }
        
        $('#segmentation-table').html(tableHtml);
        
        // 渲染分页
        renderPagination(totalPages);
    }
    
    // 格式化分词结果，添加不同词性的颜色
    function formatSegmentedWords(text) {
        return text.replace(/_[a-z]+/g, '');
    }
    
    // 格式化词性标注，添加颜色
    function formatPosTagging(text) {
        const posColors = {
            'n': 'text-primary',    // 名词
            'v': 'text-success',    // 动词
            'a': 'text-danger',     // 形容词
            'd': 'text-warning',    // 副词
            'p': 'text-info',       // 介词
            'r': 'text-secondary',  // 代词
            'c': 'text-dark',       // 连词
            'm': 'text-muted',      // 数词
            'q': 'text-primary',    // 量词
            'u': 'text-secondary',  // 助词
            'f': 'text-info',       // 方位词
            's': 'text-success',    // 处所词
            't': 'text-warning',    // 时间词
            'ns': 'text-danger',    // 地名
            'nr': 'text-primary',   // 人名
            'nz': 'text-info',      // 其他专名
            'eng': 'text-success'   // 英文
        };
        
        let formattedText = '';
        const words = text.split(' ');
        
        words.forEach(function(word) {
            if (word) {
                const parts = word.split('_');
                if (parts.length >= 2) {
                    const w = parts[0];
                    const pos = parts[1];
                    const colorClass = posColors[pos] || '';
                    
                    formattedText += `<span class="${colorClass}" title="${getPosName(pos)}">${w}_${pos}</span> `;
                } else {
                    formattedText += word + ' ';
                }
            }
        });
        
        return formattedText;
    }
    
    // 获取词性的中文名称
    function getPosName(pos) {
        const posNames = {
            'n': '名词', 'v': '动词', 'a': '形容词', 'd': '副词',
            'p': '介词', 'r': '代词', 'c': '连词', 'm': '数词',
            'q': '量词', 'u': '助词', 'f': '方位词', 's': '处所词',
            't': '时间词', 'ns': '地名', 'nr': '人名', 'nz': '其他专名',
            'eng': '英文', 'x': '标点符号', 'vn': '动名词'
        };
        
        return posNames[pos] || pos;
    }
    
    // 渲染分页
    function renderPagination(totalPages) {
        let paginationHtml = '';
        
        // 上一页按钮
        paginationHtml += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${currentPage - 1}">上一页</a>
            </li>
        `;
        
        // 页码按钮
        for (let i = 1; i <= totalPages; i++) {
            if (
                i === 1 || 
                i === totalPages || 
                (i >= currentPage - 2 && i <= currentPage + 2)
            ) {
                paginationHtml += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `;
            } else if (
                i === currentPage - 3 || 
                i === currentPage + 3
            ) {
                paginationHtml += `
                    <li class="page-item disabled">
                        <a class="page-link" href="#">...</a>
                    </li>
                `;
            }
        }
        
        // 下一页按钮
        paginationHtml += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${currentPage + 1}">下一页</a>
            </li>
        `;
        
        $('#pagination').html(paginationHtml);
        
        // 绑定分页点击事件
        $('.page-link').on('click', function(e) {
            e.preventDefault();
            
            const page = $(this).data('page');
            if (page && page !== currentPage && page >= 1 && page <= totalPages) {
                currentPage = page;
                renderTable();
            }
        });
    }
    
    // 渲染词性分布图表
    function renderPosChart() {
        // 统计词性分布
        const posStats = {};
        
        segmentationData.forEach(function(item) {
            const posTagging = item.pos_tagging;
            const words = posTagging.split(' ');
            
            words.forEach(function(word) {
                if (word) {
                    const parts = word.split('_');
                    if (parts.length >= 2) {
                        const pos = parts[1];
                        posStats[pos] = (posStats[pos] || 0) + 1;
                    }
                }
            });
        });
        
        // 转换为图表数据
        const chartData = [];
        for (const pos in posStats) {
            chartData.push({
                name: getPosName(pos) + '(' + pos + ')',
                value: posStats[pos]
            });
        }
        
        // 按数量排序
        chartData.sort(function(a, b) {
            return b.value - a.value;
        });
        
        // 只取前15个
        const topData = chartData.slice(0, 15);
        
        // 初始化图表
        const chart = echarts.init(document.getElementById('pos-chart'));
        
        // 配置图表
        const option = {
            tooltip: {
                trigger: 'item',
                formatter: '{a} <br/>{b}: {c} ({d}%)'
            },
            legend: {
                orient: 'vertical',
                right: 10,
                top: 'center',
                data: topData.map(item => item.name)
            },
            series: [
                {
                    name: '词性分布',
                    type: 'pie',
                    radius: ['50%', '70%'],
                    avoidLabelOverlap: false,
                    label: {
                        show: false,
                        position: 'center'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: '18',
                            fontWeight: 'bold'
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: topData
                }
            ]
        };
        
        // 渲染图表
        chart.setOption(option);
    }
    
    // 渲染词长分布图表
    function renderWordLengthChart() {
        // 统计词长分布
        const lengthStats = {};
        
        segmentationData.forEach(function(item) {
            const segmentedWords = item.segmented_words;
            const words = segmentedWords.split(' ');
            
            words.forEach(function(word) {
                if (word) {
                    const parts = word.split('_');
                    if (parts.length >= 2) {
                        const w = parts[0];
                        const length = w.length;
                        lengthStats[length] = (lengthStats[length] || 0) + 1;
                    }
                }
            });
        });
        
        // 转换为图表数据
        const xData = [];
        const yData = [];
        
        // 获取所有词长并排序
        const lengths = Object.keys(lengthStats).map(Number).sort((a, b) => a - b);
        
        lengths.forEach(function(length) {
            xData.push(length);
            yData.push(lengthStats[length]);
        });
        
        // 初始化图表
        const chart = echarts.init(document.getElementById('word-length-chart'));
        
        // 配置图表
        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                }
            },
            xAxis: {
                type: 'category',
                data: xData,
                name: '词长'
            },
            yAxis: {
                type: 'value',
                name: '数量'
            },
            series: [
                {
                    name: '词长分布',
                    type: 'bar',
                    data: yData,
                    itemStyle: {
                        color: function(params) {
                            // 根据词长设置不同的颜色
                            const colorList = ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de', '#3ba272', '#fc8452', '#9a60b4'];
                            return colorList[params.dataIndex % colorList.length];
                        }
                    }
                }
            ]
        };
        
        // 渲染图表
        chart.setOption(option);
    }
</script>
{% endblock %} 